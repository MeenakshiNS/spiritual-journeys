<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Supplier Details</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9fafb;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      table-layout: fixed;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
      font-size: 14px;
      position: relative;
    }
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      width: 5px;
      cursor: col-resize;
      user-select: none;
      height: 100%;
      z-index: 1;
    }
    .resizer:hover, .resizing {
      border-right: 2px solid #007bff;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px 12px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
    td input, td select {
      width: 100%;
      border: none;
      background: transparent;
      pointer-events: none;
    }
    tr.editing td input, tr.editing td select {
      background: #fff;
      border: 1px solid #ccc;
      pointer-events: auto;
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 15px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
      }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: none;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }
      td:last-child {
        border-bottom: none;
      }
      td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #333;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .controls div {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      input, select, button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Supplier Details</h1>

  <div class="controls">
    <div>
      <input type="text" id="searchInput" placeholder="Search by type, city, or company..." />
      <button id="sortCompanyBtn">Sort by Company</button>
      <button id="sortCityBtn">Sort by City</button>
    </div>
    <div>
      <button id="addBtn">‚ûï Add Supplier</button>
      <button id="saveBtn">üíæ Save All Changes</button>
    </div>
  </div>

  <div style="overflow-x:auto;">
    <table id="supplierTable">
      <thead>
        <tr>
          <th>SI No</th>
          <th>Type</th>
          <th>City</th>
          <th>Company Name</th>
          <th>Contact Name</th>
          <th>Contact Number</th>
          <th>Email ID</th>
          <th>Website</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let companies = [];

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    async function loadData() {
      const res = await fetch('/data');
      companies = await res.json();
      companies.forEach(c => { if (!c.id) c.id = generateId(); });
      companies.sort((a, b) => a.city.toLowerCase().localeCompare(b.city.toLowerCase()));
      renderTable(companies);
    }

    // ‚úÖ RENDER TABLE ‚Äî includes proper action buttons
    function renderTable(data) {
      const tbody = document.querySelector('#supplierTable tbody');
      tbody.innerHTML = '';
      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td data-label="SI No">${index + 1}</td>
          <td data-label="Type">
            <select>
              <option value="Domestic" ${item.type === "Domestic" ? "selected" : ""}>Domestic</option>
              <option value="International" ${item.type === "International" ? "selected" : ""}>International</option>
            </select>
          </td>
          <td data-label="City"><input value="${item.city || ''}" /></td>
          <td data-label="Company"><input value="${item.company || ''}" /></td>
          <td data-label="Contact Name"><input value="${item.contactName || ''}" /></td>

          <td data-label="Contact Number" class="contact-number">
            <a href="tel:${item.contactNumber || ''}" style="color:#007bff;text-decoration:none;">
              ${item.contactNumber || ''}
            </a>
          </td>
          <td data-label="Email" class="email">
            <a href="mailto:${item.email || ''}" style="color:#007bff;text-decoration:none;">
              ${item.email || ''}
            </a>
          </td>
          <td data-label="Website" class="website">
            <a href="${item.website?.startsWith('http') ? item.website : 'https://' + item.website}" target="_blank" style="color:#007bff;text-decoration:none;">
              ${item.website || ''}
            </a>
          </td>
          <td data-label="Actions">
            <button onclick="toggleEdit('${item.id}', this)">‚úèÔ∏è Edit</button>
            <button onclick="deleteRow('${item.id}')">üóëÔ∏è Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      enableColumnResizing(document.getElementById('supplierTable'));
    }

    // ‚úÖ EDIT / SAVE TOGGLE
    function toggleEdit(id, btn) {
      const row = btn.closest('tr');
      const isEditing = row.classList.toggle('editing');
      const tds = row.querySelectorAll('td');
      const item = companies.find(c => c.id === id);

      if (isEditing) {
        btn.textContent = 'üíæ Save';
        tds[5].innerHTML = `<input value="${item.contactNumber || ''}" />`;
        tds[6].innerHTML = `<input value="${item.email || ''}" />`;
        tds[7].innerHTML = `<input value="${item.website || ''}" />`;
      } else {
        btn.textContent = '‚úèÔ∏è Edit';
        const cells = row.querySelectorAll('input, select');
        const updated = {
          id,
          type: cells[0].value,
          city: cells[1].value,
          company: cells[2].value,
          contactName: cells[3].value,
          contactNumber: cells[4].value,
          email: cells[5].value,
          website: cells[6].value
        };
        const index = companies.findIndex(c => c.id === id);
        companies[index] = updated;
        companies.sort((a, b) => a.city.toLowerCase().localeCompare(b.city.toLowerCase()));
        renderTable(companies);
      }
    }

    // ‚úÖ DELETE ROW (always works)
    function deleteRow(id) {
      if (confirm("Are you sure you want to delete this supplier?")) {
        companies = companies.filter(c => c.id !== id);
        renderTable(companies);
      }
    }

    // ADD NEW ROW
    document.getElementById('addBtn').addEventListener('click', () => {
      companies.push({
        id: generateId(),
        type: "Domestic",
        city: '',
        company: '',
        contactName: '',
        contactNumber: '',
        email: '',
        website: ''
      });
      companies.sort((a, b) => a.city.toLowerCase().localeCompare(b.city.toLowerCase()));
      renderTable(companies);
    });

    // SORT / SEARCH / SAVE / DOWNLOAD
    let cityAsc = true;
    let companyAsc = true;

    document.getElementById('sortCompanyBtn').addEventListener('click', () => {
      companies.sort((a, b) =>
        companyAsc
          ? a.company.toLowerCase().localeCompare(b.company.toLowerCase())
          : b.company.toLowerCase().localeCompare(a.company.toLowerCase())
      );
      companyAsc = !companyAsc;
      renderTable(companies);
    });

    document.getElementById('sortCityBtn').addEventListener('click', () => {
      companies.sort((a, b) =>
        cityAsc
          ? a.city.toLowerCase().localeCompare(b.city.toLowerCase())
          : b.city.toLowerCase().localeCompare(a.city.toLowerCase())
      );
      cityAsc = !cityAsc;
      renderTable(companies);
    });

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const keyword = e.target.value.toLowerCase();
      const filtered = companies.filter(c =>
        c.type.toLowerCase().includes(keyword) ||
        c.city.toLowerCase().includes(keyword) ||
        c.company.toLowerCase().includes(keyword)
      );
      renderTable(filtered);
    });

    document.getElementById('saveBtn').addEventListener('click', async () => {
      try {
        const res = await fetch('/data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(companies, null, 2)
        });
        if (!res.ok) throw new Error('Failed to save');
        alert('‚úÖ All data saved successfully!');
      } catch (err) {
        alert('‚ùå Error saving data.');
        console.error(err);
      }
    });

    const downloadBtn = document.createElement('button');
    downloadBtn.textContent = '‚¨áÔ∏è Download JSON';
    downloadBtn.style.marginLeft = '10px';
    document.querySelector('.controls div:last-child').appendChild(downloadBtn);

    downloadBtn.addEventListener('click', () => {
      const jsonWithIndex = companies.map((c, i) => ({
        "SI No": i + 1,
        Type: c.type,
        City: c.city,
        Company: c.company,
        "Contact Name": c.contactName,
        "Contact Number": c.contactNumber,
        "Email ID": c.email,
        Website: c.website
      }));
      const date = new Date().toISOString().split('T')[0];
      const blob = new Blob([JSON.stringify(jsonWithIndex, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `suppliers_${date}.json`;
      link.click();
    });

    // ‚úÖ COLUMN RESIZING
    function enableColumnResizing(table) {
      const ths = table.querySelectorAll('th');
      ths.forEach(th => {
        if (th.querySelector('.resizer')) return;
        const resizer = document.createElement('div');
        resizer.classList.add('resizer');
        th.appendChild(resizer);

        let startX, startWidth;
        resizer.addEventListener('mousedown', (e) => {
          startX = e.pageX;
          startWidth = th.offsetWidth;
          th.classList.add('resizing');

          const onMouseMove = (e) => {
            const newWidth = startWidth + (e.pageX - startX);
            th.style.width = newWidth + 'px';
          };

          const onMouseUp = () => {
            th.classList.remove('resizing');
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          };

          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
    }

    loadData();
  </script>
</body>
</html>
